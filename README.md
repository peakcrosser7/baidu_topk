本次比赛为 [基于向量交集的TopK搜索](https://aistudio.baidu.com/competition/detail/1046/0/introduction), [参赛手册](https://docs.qq.com/doc/DSUxrVVZEeVljdEdr) 中包含了 baseline 代码和测试数据

评测机器为 A100，本文档中所有数据是在 A4500 显卡上的测试结果。

## （1）Baseline 分析
|  query   | 总耗时  | 分配显存 | 内存 memset | 内存操作 | cudaMemcpy | topk |
|  ----  | ----  | ----| ---- | ---- | ---- | ---- |
| 9  | 1159 | 52 | 547 | 811 | 85 | 98 |
| 100  | 2113 | 57 | 547 | 811 | 94 | 1022 | 

不同规模的 query 数耗时分布不同
- 对于 query 数比较小的时候，耗时主要集中在内存操作上，其中的内存 memset 就占据了一半的时间
- 对于 query 数比较大的时候，耗时主要集中在 topk 的计算上

> **Baseline 版本代码评测得分为 0.00019**

## (2) 优化方案一： 多线程
首先通过多线程来加速内存操作，由于不清楚评测机器的 cpu 核数，测试了 8 和 32 两种线程数，发现线程数为 8 时得分更高。

### 2.1 使用多线程来加速内存操作
分析线程数为 8 时的耗时情况：
|  query   | 总耗时  | 分配显存 | 内存 memset | 内存操作 | cudaMemcpy | topk | 总体加速比 |
|  ----  | ----  | ----| ---- | ---- | ---- | ---- | ---- |
| 9  | 529 | 52 | 94 | 174 | 82 | 101 | 2.2 |
| 100  | 1451 | 51 | 95 | 183 | 91| 1004| 1.46 |

> **该版本评测得分为 0.00029, 得分为 base 1.53 倍**

### 2.2 使用多线程来加速 topk 计算
从评测得分来看，评测数据中存在 query 数较大的情况，所以需要优化 topk 的计算，继续使用多线程的分案来优化 topk 的计算。

分析线程数为 8 时的耗时情况：
|  query   | 总耗时  | 分配显存 | 内存 memset | 内存操作 | cudaMemcpy | topk | 总体加速比 |
|  ----  | ----  | ----| ---- | ---- | ---- | ---- | ---- |
| 9  | 547 | 59 | 95 | 181 | 82 | 105  | 2.12 |
| 100  | 909 | 55 | 95 | 183 | 91 | 459 | 2.32 |

> **该版本评测得分为 0.00047, 得分为 base 2.47 倍**